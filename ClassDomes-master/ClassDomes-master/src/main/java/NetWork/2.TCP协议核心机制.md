# TCP/IP 五层协议
## 应用层
     * 程序员最常打交道的一层，其他四层都是操作系统、驱动、硬件实现好了的
     * 这一层最重要的就是【设计并实现应用层协议】 这是工作中经常要做的事情
     * 设计一个应用层协议 主要就是包含两个工作：
     * 1.明确传输的信息（根据需求） 2.明确数据的组织格式（json xml protobuffer HTTP）
## 传输层
     * 虽然传输层是操作系统内核实现的，我们不需要直接和传输层打交道，但是对于我们仍然意义重大
     * 进行网络编程都要用到Socket，调用了Socket就进入了传输层的范畴
     * 如果一切顺利就还好，一旦代码出现bug，为了解决和理解这些bug，传输层的一些知识就是必要的。
     * 传输层协议最常见的就是 UTP 和 TCP
     
     * UDP 报头包含4部分 ： 2个字节大小的源端口
     *                   2个字节大小的目的端口
     *                   2个字节大小的报文长度（致命缺陷 ：无法表示一个大于64K的数据报）
     *                   2个字节大小的校验和（校验和是用来验证网络传输的数据是否正确，但是不能保证100%对）
     
     * Tcp 协议格式： 16位源端口
     *              16位目的端口
     *              32位序号
     *              32位确认序号
     *              4位首部长度（表示报头长度，它是变长的，不像 UDP 是固定8字节；报头的长度为 首部实际长度*4）
     *              保留（6位）：现在还不用，为了未来升级留的空间
     *              6个标志位：TCP的核心
     *              16位窗口大小：
     *              16位校验和：
     *              16位紧急指针：
     *              选项：
     *              数据：
---
# TCP 核心机制
+ 机制核心是可靠传输,可靠不等于安全,可靠是一种回应,发出去的收到没收到,可以确定知道 就是可靠！
---
## 1. 确认应答。（保障可靠性）
+ 接收方收到消息之后,给发送方返回一个应答报文 (ACK)，表示自己已经收到了！  
+ 对数据进行编号（序号），防止后发先至。同样，应答报文也会加上确认序号。表示针对哪个消息就行应答！
+ TCP 报文中的 [32位序号]、[32位确认序号] 就是干这个事的！  
（以字节为单位进行编号,比如 数据1~1000（字节）定义为序号1（将这1000个字节数据封装为一个TCP数据报），确认应答序号为1001，表示小于1001的数据都已经被主机收到了。数据1001-2000用序号1001表示，确认应答序号就为2001）  
---
## 2. 超时重传 （保障可靠性）
+ 相当于对确认应答进行有效的补充：确认应答是网络一切正常的时候，通过ACK通知对方收到了。如果出现丢包的情况，超时重传机制就要起作用了！
+ 没有收到ACK，超过一定时间，就会超时重传，重新封装数据报发送，存在操作系统内核的“接收缓冲区”内，收到新的数据就会根据序号查看是否已存在，将会进行去重操作。保证应用层数据拿到的数据一定不重复！
+ 连续几次重传仍不成功，就认为网络收到不可逆损耗（比如被拔了网线），就会自动断开TCP连接！
---
## 3. 连接管理 （保证可靠性）
+ 解决 如何建立连接？如何断开连接？ 
#### a.如何建立连接
+ 三次握手  
        [一次握手] 客户端主动发送 SYN （同步报文段）给服务器；如果 SYN 为1，就表示当前报文为一个同步报文段，主机A准备好和主机B之间要建立连接！
        [二次握手] 服务器返回一个 ACK 表示收到 并同时也会返回一个 SYN，表示主机B 也准备好和主机A建立连接了！
        [三次握手] 客户端收到后 会返回给 服务器一个 ACK 表示收到！
+ 三次握手和可靠性的关系
        三次握手相当于投石问路，检车一下网络当前的情况是否满足可靠传输的基本情况！如果网络本身就很差，强行进行TCP传输也会涉及到大量丢包。  
        三次握手的过程就是验证通讯双方的发送和接收能力是否正常。
+ 为什么握手是三次？两次行不行？四次行不行？
        两次是绝对不行的,缺少最后一次，客户端关于发送接收能力的情报是正常的，但是服务器这边是残缺的，对于能否满足可靠传输是没底的！ 
        四次是将第二次握手中 SYN 和 ACK 分开发 ，可以但是没有必要！
#### b.如何断开连接
+ 四次挥手  
        双方各自给对方发送一个 FIN（结束报文段）请求，并且各自给对方一个 ACK确认报文！
        和三次挥手区别是:  1.三次握手一定是客户端主动发起; 四次挥手 是双方都有可能主动发起。
                        2.三次握手中间两次能合并，四次挥手中间两次大概率合并不了。不能合并的原因B发送ACK 和 B发送FIN的时机是不同的。
                        
        [一次挥手] 客户端向服务端 发送 FIN （我要和你分手）
        [二次挥手] 服务端返回 ACK （同意）
        [三次挥手] 服务端向客户端发送 FIN （我也要和你分手）
        [四次挥手] 客户端返回 ACK （同意）
## 4. 滑动窗口 (保证可靠性的前提下，尽可能提高传输效率)
+ 本质是批量的发送数据


## 5. 流量控制 (属于滑动窗口的延申，目的是为了保证可靠性)
+ 关键就是能够衡量接收方的处理速度
+ 接收方接收缓冲区剩余空间大小来衡量当前处理能力


## 6. 拥塞控制 


## 7. 延时应答


## 8. 捎带应答


## 9. 面向字节流 (粘包问题)


## 10. 异常处理


---
## 网络层
+ IP协议是网络层最重要的协议
+ 完成两方面工作：1.地址管理 2.路由管理

